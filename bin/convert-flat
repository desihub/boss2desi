#!/usr/bin/env python

from boss2desi import frame2brick
import fitsio
import argparse


if __name__=="__main__":
    parser = argparse.ArgumentParser(formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    
    parser.add_argument("--flat",type=str,default=None,required=True,help="flat file")
    parser.add_argument("--cframe",type=str,default=None,required=True,help="cframe file. Required to read the wavelength solution of the flat and wdisp.")
    parser.add_argument("--out",type=str,default=None,required=True,help="output file")
    parser.add_argument("--lambda-min",type=float,default=3000,required=False,help="minimum wavelength")
    parser.add_argument("--lambda-max",type=float,default=10000,required=False,help="maximum wavelength")

    args=parser.parse_args()

    flat=fitsio.FITS(args.flat)
    flux = flat[0].read()
    ivar = flat[1].read()
    mask = flat[2].read()
    sky  = None

    ## read wdisp fibermap and wavelenghts and wdisp from cframe
    cframe=fitsio.FITS(args.cframe)
    camera = cframe[0].read_header()["CAMERAS"].strip()
    wave = 10**flat[3].read()
    wave_wdisp = 10**cframe[3].read()[:,:flux.shape[1]]
    wave_new = wave[249,:]
    ## wavelength cuts:
    w = (wave_new > args.lambda_min) & (wave_new < args.lambda_max)
    wave_new = wave_new[w]

    wdisp= cframe[4].read()[:,:flux.shape[1]]
    fibermap = cframe[5]

    b=frame2brick.brick(flux,ivar,mask,wave,wave_new,wdisp,camera,fibermap,sky=sky,wave_wdisp=wave_wdisp)

    b.export(args.out)


    
