#!/usr/bin/env python
from __future__ import print_function
import argparse
import numpy as np

from boss2desi import io,fibermap
from boss2desi.frame import resample

if __name__=="__main__":
    parser = argparse.ArgumentParser(formatter_class=argparse.ArgumentDefaultsHelpFormatter)
    
    parser.add_argument("--spplate",type=str,default=None,required=True,help="spplate file")
    parser.add_argument("--fibers",type=int,default=None,required=False,help="list of fibers",nargs="*")
    parser.add_argument("--outdir",type=str,default=None,required=True,help="output directory")
    parser.add_argument("--ncpu",type=int,default=None,required=False,help="number of cpus")
    parser.add_argument("--flat-dir",type=str,default=None,required=False,help="flat extractions dir")

    args = parser.parse_args()

    frames = io.get_frames(args.spplate,fibers=args.fibers,flatdir=args.flat_dir)

    ## get the wavelength from the first exposure and the central fiber
    llmin_b = 3600.
    llmax_b = 6200.
    ref_fiber_index = 249
    wave_new = {}
    for frame in frames:
        if frame.camera[0]=="b":    
            wave_new["b"] = frame.spectra[ref_fiber_index].wave
            w = (wave_new["b"]>llmin_b) & (wave_new["b"] < llmax_b)
            wave_new["b"] = wave_new["b"][w]
            break
    llmin_r = 6000.
    llmax_r = 10000.
    for frame in frames:
        if frame.camera[0]=="r":
            wave_new["r"] = frame.spectra[0].wave
            w = (wave_new["r"]>llmin_r) & (wave_new["r"] < llmax_r)
            wave_new["r"] = wave_new["r"][w]
            break

    wdisp_max = [s.wdisp.max() for frame in frames for s in frame.spectra]
    wdisp_max = max(wdisp_max)
    ndiag = int(4*np.ceil(wdisp_max)+1)
    print("INFO: setting ndiag to : {}".format(ndiag))

    header, colnames, fibermap = fibermap.desi_fibermap(args.spplate)
    for frame in frames:
        resampled_frame = resample(frame,wave_new[frame.camera[0]],ndiag,ncpu = args.ncpu)
        io.export_frame(resampled_frame,header,fibermap,colnames,args.outdir)

